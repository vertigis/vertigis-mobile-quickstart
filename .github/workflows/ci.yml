name: CI

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]

jobs:
    Android:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v2

            - name: Setup msbuild
              uses: microsoft/setup-msbuild@v1

            - uses: actions/setup-java@v2
              with:
                  distribution: 'microsoft'
                  java-version: '11'

            - name: Restore NuGet packages
              run: msbuild -t:restore
              working-directory: App1/App1.Android

            - name: msbuild
              # TODO: Enable `-warnAsError` flag once package conflicts are resolved.
              run: msbuild
              working-directory: App1/App1.Android
    iOS:
        runs-on: macos-13
        steps:
            - uses: actions/checkout@v2

            - name: Install Xamarin.iOS
              run: |
                dotnet tool install --global boots
                boots https://download.visualstudio.microsoft.com/download/pr/de7f727f-243c-4429-8773-eebd735eb1bb/da4a65f27ace7f805914ef63661e0efd/xamarin.ios-16.4.0.18.pkg

            # Fixes error when using newer NuGet packages that require a minimum version of Xcode
            - name: Use Xcode 14.3.1
              uses: maxim-lobanov/setup-xamarin@v1
              with:
                  xcode-version: 14.3.1

            # The following two workaround steps can be removed when the following github issue is resolved: https://github.com/actions/virtual-environments/issues/5768
            - name: Restore Workaround Remove
              run: rm -rf ~/.config/NuGet/NuGet.Config
              shell: bash

            - name: Restore Workaround List
              run: dotnet nuget list source
              shell: bash

            - name: Restore NuGet packages
              run: msbuild -t:restore
              working-directory: App1/App1.iOS

            - name: msbuild
              # TODO: Enable `-warnAsError` flag once package conflicts are resolved.
              run: msbuild
              working-directory: App1/App1.iOS
    Windows:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v2

            - name: Setup msbuild
              uses: microsoft/setup-msbuild@v1
              
            - name: "Update windows SDK"
              uses: fbactions/setup-winsdk@v1
              with:
                winsdk-build-version: 18362

            - name: Restore NuGet packages
              run: msbuild -t:restore
              working-directory: App1/App1.UWP

            - name: msbuild
              # TODO: Enable `-warnAsError` flag once XF is updated, and warnings aren't shown:
              # https://developercommunity.visualstudio.com/content/problem/1251681/xamarinforms-application-warning.html
              run: msbuild
              working-directory: App1/App1.UWP
